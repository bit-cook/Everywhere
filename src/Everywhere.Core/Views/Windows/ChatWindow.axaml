<v:ReactiveShadWindow
  x:Class="Everywhere.Views.ChatWindow" xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:be="clr-namespace:Everywhere.Behaviors"
  xmlns:chat="clr-namespace:Everywhere.Chat" xmlns:common="clr-namespace:Everywhere.Common"
  xmlns:p="clr-namespace:Everywhere.Chat.Plugins" xmlns:shadui="clr-namespace:ShadUI.Controls;assembly=ShadUI"
  xmlns:sys="clr-namespace:System;assembly=System.Runtime" xmlns:v="clr-namespace:Everywhere.Views"
  xmlns:vc="clr-namespace:Everywhere.ValueConverters" xmlns:vm="clr-namespace:Everywhere.ViewModels"
  Title="{I18N {x:Static LocaleKey.ChatWindow_Title}}"
  MinWidth="400" MinHeight="224"
  x:DataType="vm:ChatWindowViewModel" x:TypeArguments="vm:ChatWindowViewModel"
  Background="{DynamicResource AcrylicWindowBackgroundColor}"
  BorderBrush="{DynamicResource BorderColor}"
  ExtendClientAreaChromeHints="NoChrome" ExtendClientAreaToDecorationsHint="True"
  IsOpened="{Binding IsOpened, Mode=OneWayToSource}"
  ShowActivated="False" SizeToContent="WidthAndHeight"
  TransparencyLevelHint="AcrylicBlur" WindowStartupLocation="CenterScreen">

  <v:ReactiveShadWindow.BorderThickness>
    <OnPlatform
      x:TypeArguments="Thickness" Linux="0"
      Windows="1" macOS="0"/>
  </v:ReactiveShadWindow.BorderThickness>

  <v:ReactiveShadWindow.Hosts>
    <shadui:DialogHost
      x:Name="PART_DialogHost"
      Owner="{Binding RelativeSource={RelativeSource AncestorType=v:ChatWindow}}"/>
    <shadui:ToastHost
      x:Name="PART_ToastHost" Margin="0,36,0,0"/>
  </v:ReactiveShadWindow.Hosts>

  <v:ReactiveShadWindow.TitleBarContentOverride>
    <Border
      x:Name="TitleBarBorder" Grid.Row="0"
      Height="44" Padding="8,0"
      Background="Transparent">
      <Border.FlowDirection>
        <OnPlatform
          x:TypeArguments="FlowDirection" Linux="LeftToRight"
          Windows="LeftToRight" macOS="RightToLeft"/>
      </Border.FlowDirection>

      <DockPanel LastChildFill="True">
        <v:Eva
          DockPanel.Dock="Left" Width="36"
          Height="36" Margin="0,0,0,-4"
          IsThinking="{Binding IsBusy}">
          <v:Eva.Effect>
            <DropShadowEffect
              OffsetX="1.5" OffsetY="1.5"
              Opacity="0.3"/>
          </v:Eva.Effect>
        </v:Eva>

        <StackPanel
          DockPanel.Dock="Right" VerticalAlignment="Center"
          Orientation="Horizontal" Spacing="4">
          <StackPanel.Styles>
            <Style Selector=":is(Button).TitleBar">
              <Setter Property="Focusable" Value="False"/>
              <Setter Property="Height" Value="28"/>
              <Setter Property="MinHeight" Value="28"/>
              <Setter Property="MinWidth" Value="28"/>
              <Setter Property="Width" Value="28"/>
              <Setter Property="Padding" Value="0"/>
              <Setter Property="CornerRadius" Value="4"/>
              <Setter Property="Background" Value="Transparent"/>

              <Style Selector="^.Close /template/ Border#HoverBackground">
                <Setter Property="Background" Value="#C42B1C"/>
              </Style>

              <Style Selector="^ LucideIcon">
                <Setter Property="Size" Value="20"/>
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
              </Style>
            </Style>

            <Style Selector="ToggleButton.TitleBar">
              <Setter Property="BorderBrush" Value="Transparent"/>
              <Setter Property="shadui:ButtonAssist.CheckedForeground" Value="{DynamicResource PrimaryForegroundColor}"/>
              <Setter Property="shadui:ButtonAssist.CheckedBackground" Value="{DynamicResource PrimaryColor50}"/>

              <Style Selector="^:checked">
                <Style Selector="^ LucideIcon">
                  <Setter Property="Kind" Value="Pin"/>
                </Style>
              </Style>

              <Style Selector="^:indeterminate">
                <Setter Property="BorderBrush" Value="{DynamicResource PrimaryColor50}"/>

                <Style Selector="^ LucideIcon">
                  <Setter Property="Kind" Value="Pin"/>
                  <Setter Property="RenderTransform" Value="rotate(45deg)"/>
                </Style>
              </Style>

              <Style Selector="^:unchecked">
                <Style Selector="^ LucideIcon">
                  <Setter Property="Kind" Value="PinOff"/>
                </Style>
              </Style>
            </Style>

            <Style Selector="FlyoutPresenter">
              <Setter Property="BorderBrush" Value="{DynamicResource AcrylicBorderBrush}"/>
              <Setter Property="BorderThickness" Value="1"/>
              <Setter Property="CornerRadius" Value="8.5"/>
              <Setter Property="Padding" Value="0"/>
            </Style>

            <Style Selector="MenuFlyoutPresenter">
              <Setter Property="BorderBrush" Value="{DynamicResource AcrylicBorderBrush}"/>
              <Setter Property="BorderThickness" Value="1"/>
              <Setter Property="CornerRadius" Value="8.5"/>
              <Setter Property="Padding" Value="0"/>

              <Style Selector="^ MenuItem.MenuFlyoutMenuItem /template/ Border#HoverBackground">
                <Setter Property="Background" Value="{DynamicResource SecondaryCardBackgroundColor}"/>
              </Style>
            </Style>

            <Style Selector="Expander:not(.CanExpand)">
              <Style Selector="^ ToggleButton#PART_ToggleButton">
                <Setter Property="IsEnabled" Value="False"/>
              </Style>
              <Style Selector="^ LucideIcon#PART_Icon">
                <Setter Property="IsVisible" Value="False"/>
              </Style>
              <Style Selector="^ ContentControl#ContentExpandControlContainer">
                <Setter Property="IsVisible" Value="False"/>
              </Style>
            </Style>
          </StackPanel.Styles>

          <Button
            x:Name="HistoryButton" Classes="Ghost TitleBar"
            Command="{Binding ChatContextManager.UpdateRecentHistoryCommand}"
            Content="{LucideIconContent History}"
            FlowDirection="LeftToRight"
            IsVisible="{Binding !IsViewingHistory}"
            ToolTip.Tip="{I18N {x:Static LocaleKey.ChatWindow_History_ToolTip}}">
            <Button.Flyout>
              <Flyout ShowMode="Transient">
                <DockPanel>
                  <Button
                    Classes="NoPressedAnimation" DockPanel.Dock="Bottom"
                    Padding="0,6"
                    BorderBrush="{DynamicResource BorderColor}"
                    BorderThickness="0,1,0,0"
                    Content="{I18N {x:Static LocaleKey.ChatWindow_ViewAllHistoryButton_Content}}"
                    CornerRadius="0,0,8,8">
                    <Interaction.Behaviors>
                      <ButtonClickEventTriggerBehavior>
                        <ButtonClickEventTriggerBehavior.Actions>
                          <HideFlyoutAction Flyout="{Binding #HistoryButton.Flyout}"/>
                          <InvokeCommandAction
                            Command="{Binding SwitchViewingHistoryCommand}"
                            CommandParameter="True"/>
                        </ButtonClickEventTriggerBehavior.Actions>
                      </ButtonClickEventTriggerBehavior>
                    </Interaction.Behaviors>
                  </Button>

                  <ScrollViewer
                    Width="200" MaxHeight="400"
                    HorizontalContentAlignment="Stretch" HorizontalScrollBarVisibility="Disabled"
                    VerticalScrollBarVisibility="Auto">
                    <ItemsControl
                      Margin="8" Padding="0"
                      ItemsSource="{Binding ChatContextManager.RecentHistory}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <StackPanel
                            Orientation="Vertical" Spacing="8"/>
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>

                      <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="chat:ChatContextHistory">
                          <StackPanel
                            Orientation="Vertical" Spacing="4">
                            <TextBlock
                              Classes="Muted" HorizontalAlignment="Left"
                              FontSize="{DynamicResource FontSizeS}">
                              <TextBlock.Text>
                                <I18N Key="{Binding Date, Converter={x:Static vc:DynamicResourceKeyConverter.Shared}}"/>
                              </TextBlock.Text>
                            </TextBlock>

                            <ListBox
                              Padding="0" Background="Transparent"
                              BorderThickness="0" CornerRadius="0"
                              ItemsSource="{Binding MetadataList}"
                              ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                              SelectedItem="{Binding $parent[v:ChatWindow].ViewModel.ChatContextManager.CurrentMetadata, FallbackValue={x:Null}}">
                              <ListBox.Styles>
                                <Style Selector="ListBoxItem">
                                  <Setter Property="Padding" Value="8,6"/>
                                  <Setter Property="CornerRadius" Value="4"/>
                                </Style>
                              </ListBox.Styles>

                              <ListBox.ItemTemplate>
                                <DataTemplate DataType="chat:ChatContextMetadata">
                                  <TextBlock
                                    Text="{Binding ActualTopic}"
                                    TextTrimming="CharacterEllipsis"/>
                                </DataTemplate>
                              </ListBox.ItemTemplate>
                            </ListBox>
                          </StackPanel>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </ScrollViewer>
                </DockPanel>
              </Flyout>
            </Button.Flyout>
          </Button>

          <Button
            Classes="Ghost TitleBar"
            Command="{Binding ChatContextManager.CreateNewCommand}"
            Content="{LucideIconContent Plus}"
            HotKey="Ctrl+N"
            ToolTip.Tip="{I18N {x:Static LocaleKey.ChatWindow_CreateNew_ToolTip}}"/>

          <ToggleButton
            Classes="Ghost TitleBar" Background="#00252525"
            BorderThickness="1.5" HotKey="Ctrl+D"
            IsChecked="{Binding $parent[v:ChatWindow].IsWindowPinned, Mode=TwoWay}"
            IsThreeState="True"
            ToolTip.Tip="{I18N {x:Static LocaleKey.ChatWindow_TogglePin_ToolTip}}">
            <LucideIcon Size="16"/>
          </ToggleButton>

          <Button
            Classes="Ghost TitleBar Close"
            Command="{Binding CloseCommand}"
            Content="{LucideIconContent X}"
            HotKey="Ctrl+W"
            ToolTip.Tip="{I18N {x:Static LocaleKey.ChatWindow_Close_ToolTip}}"/>
        </StackPanel>

        <TextBlock
          Classes="Large" Margin="8,0,0,0"
          VerticalAlignment="Center" IsHitTestVisible="False"
          Text="{Binding ChatContextManager.Current.Metadata.ActualTopic}"
          TextTrimming="CharacterEllipsis">
          <TextBlock.Transitions>
            <Transitions>
              <shadui:StringTransition
                Easing="CubicEaseInOut" Property="Text"
                Duration="0:0:0.4"/>
            </Transitions>
          </TextBlock.Transitions>
        </TextBlock>
      </DockPanel>
    </Border>
  </v:ReactiveShadWindow.TitleBarContentOverride>

  <v:ReactiveShadWindow.Styles>
    <Style Selector=":is(Button).Rounded">
      <Setter Property="MinHeight" Value="{DynamicResource FontSize3Xl}"/>
      <Setter Property="Height" Value="{DynamicResource FontSize3Xl}"/>
      <Setter Property="MinWidth" Value="{DynamicResource FontSize3Xl}"/>
      <Setter Property="Width" Value="{DynamicResource FontSize3Xl}"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="CornerRadius" Value="{DynamicResource FullCornerRadius}"/>
    </Style>
  </v:ReactiveShadWindow.Styles>

  <Panel Margin="0,12,0,0">
    <Grid
      x:Name="ChatMessageRootGrid"
      IsVisible="{Binding !IsViewingHistory}"
      RowDefinitions="*,Auto">
      <ScrollViewer
        x:Name="ChatMessageScrollViewer" Grid.Row="0"
        DockPanel.Dock="Top" HorizontalContentAlignment="Stretch"
        HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
        <Interaction.Behaviors>
          <be:AutoScrollBehavior/>
        </Interaction.Behaviors>

        <Panel>
          <Panel.Styles>
            <Style Selector="shadui|Loading">
              <Setter Property="Foreground" Value="{DynamicResource SukiLowText}"/>
            </Style>
          </Panel.Styles>

          <StackPanel
            Margin="8,0,8,8"
            IsVisible="{Binding ChatContextManager.Current.DisplayItems.Count, Converter={x:Static vc:Int32Converters.NotGreaterThan}, ConverterParameter=1}"
            Spacing="8">
            <ToggleSwitch
              HorizontalAlignment="Center" shadui:ToggleSwitchAssist.RightAlignedContent="True"
              IsChecked="{Binding ChatContextManager.Current.Metadata.IsTemporary, Mode=TwoWay}"
              OffContent="{I18N {x:Static LocaleKey.ChatContext_Temporary}}"
              OnContent="{I18N {x:Static LocaleKey.ChatContext_Temporary}}"/>

            <ItemsControl
              IsVisible="{Binding $self.ItemCount, Converter={x:Static vc:Int32Converters.GreaterThan}, ConverterParameter=0}"
              ItemsSource="{Binding QuickActions}">
              <ItemsControl.DataTemplates>
                <DataTemplate DataType="common:DynamicNamedCommand">
                  <Button
                    Classes="Secondary Outline" Height="NaN"
                    MinHeight="32" Padding="12,4"
                    Command="{Binding Command}"
                    CommandParameter="{Binding CommandParameter}"
                    CornerRadius="{DynamicResource FullCornerRadius}">
                    <StackPanel
                      VerticalAlignment="Center" Orientation="Vertical"
                      Spacing="4">
                      <StackPanel
                        Orientation="Horizontal" Spacing="6">
                        <LucideIcon
                          VerticalAlignment="Center"
                          Kind="{Binding Icon}"
                          Size="19"/>
                        <TextBlock
                          VerticalAlignment="Center"
                          Text="{Binding HeaderKey^}"/>
                      </StackPanel>

                      <TextBlock
                        IsVisible="{Binding DescriptionKey, Converter={x:Static ObjectConverters.IsNotNull}}"
                        Text="{Binding DescriptionKey^, FallbackValue={x:Null}}"
                        TextWrapping="Wrap"/>
                    </StackPanel>
                  </Button>
                </DataTemplate>
              </ItemsControl.DataTemplates>

              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <WrapPanel
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    ItemSpacing="8" ItemsAlignment="Center"
                    LineSpacing="6"/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
            </ItemsControl>
          </StackPanel>

          <v:ChatMessageItemsControl
            Margin="8,0" Padding="8,0"
            IsVisible="{Binding $self.ItemCount, Converter={x:Static vc:Int32Converters.GreaterThan}, ConverterParameter=0}"
            ItemsSource="{Binding ChatContextManager.Current.DisplayItems}"/>
        </Panel>
      </ScrollViewer>

      <Button
        Classes="Primary Rounded" Grid.Row="0"
        Margin="8" HorizontalAlignment="Right"
        VerticalAlignment="Bottom"
        Command="{Binding #ChatMessageScrollViewer.ScrollToEnd}"
        Focusable="False"
        ToolTip.Tip="{I18N {x:Static LocaleKey.ChatWindow_ScrollToBottom_ToolTip}}">
        <Button.IsVisible>
          <MultiBinding Converter="{x:Static vc:DoubleConverters.MultiSmallerThanAny}">
            <Binding
              Converter="{x:Static vc:DoubleConverters.Plus}"
              ConverterParameter="30" Path="#ChatMessageScrollViewer.Offset.Y"/>
            <Binding Path="#ChatMessageScrollViewer.ScrollBarMaximum.Y"/>
          </MultiBinding>
        </Button.IsVisible>

        <LucideIcon
          Kind="ArrowDown"
          Size="{DynamicResource FontSizeXl}"/>
      </Button>

      <Border
        Grid.Row="1" Padding="8"
        Background="{DynamicResource CardBackgroundColor}"
        BorderBrush="{DynamicResource BorderColor60}"
        BorderThickness="0,1,0,0">
        <StackPanel
          Orientation="Vertical" Spacing="4">
          <Border
            Margin="-8,-8,-8,0" Padding="10,2"
            Background="{DynamicResource SuccessColor20}"
            BorderBrush="{DynamicResource BorderColor}"
            BorderThickness="0,0,0,1"
            IsVisible="{Binding ChatContextManager.Current.BusyMessage, Converter={x:Static ObjectConverters.IsNotNull}, Delay=200}">
            <StackPanel
              Orientation="Horizontal" Spacing="4">
              <shadui:Loading
                Width="14" Height="14"/>
              <TextBlock
                Classes="Small"
                Text="{Binding ChatContextManager.Current.BusyMessage}"/>
            </StackPanel>
          </Border>

          <Border
            Margin="-8,-8,-8,0" Padding="10,2"
            Background="{DynamicResource WarningColor20}"
            BorderBrush="{DynamicResource BorderColor}"
            BorderThickness="0,0,0,1"
            IsVisible="{Binding EditingUserMessageNode, Converter={x:Static ObjectConverters.IsNotNull}}">
            <DockPanel LastChildFill="True">
              <Button
                Classes="Ghost Compact" DockPanel.Dock="Right"
                Padding="2,1" VerticalAlignment="Center"
                Command="{Binding $parent[v:ChatWindow].ViewModel.CancelEditingCommand}"
                CommandParameter="{Binding}"
                ToolTip.Tip="{I18N {x:Static LocaleKey.ChatWindow_CancelEditingButton_ToolTip}}">
                <StackPanel Orientation="Horizontal">
                  <LucideIcon
                    Margin="0,1,0,-1" Kind="X"
                    Size="14"/>
                  <TextBlock
                    Classes="Small"
                    Text="{I18N {x:Static LocaleKey.Common_Cancel}}"/>
                </StackPanel>
              </Button>

              <StackPanel
                Orientation="Horizontal" Spacing="4">
                <LucideIcon
                  Kind="SquarePen" Size="14"/>
                <TextBlock
                  Classes="Small" VerticalAlignment="Center"
                  Text="{I18N {x:Static LocaleKey.ChatWindow_EditingTextBlock_Text}}"/>
              </StackPanel>
            </DockPanel>
          </Border>

          <v:ChatInputArea
            x:Name="ChatInputArea" AcceptsReturn="True"
            CancelCommand="{Binding CancelCommand}"
            CaretIndex="{x:Static sys:Int32.MaxValue}"
            ChatAttachmentItemsSource="{Binding ChatAttachments}"
            Command="{Binding SendMessageCommand}"
            CustomAssistantItemsSource="{Binding Settings.Model.CustomAssistants}"
            Focusable="True"
            IsSendButtonEnabled="{Binding !IsBusy}"
            IsToolCallEnabled="{Binding PersistentState.IsToolCallEnabled, Mode=TwoWay}"
            IsToolCallSupported="{Binding Settings.Model.SelectedCustomAssistant.IsFunctionCallingSupported, FallbackValue={x:False}}"
            MaxChatAttachmentCount="{Binding PersistentState.MaxChatAttachmentCount}"
            MaxLength="{Binding ChatInputAreaTextMaxLength}"
            MaxLines="12"
            RemoveAttachmentCommand="{Binding RemoveAttachmentCommand}"
            SelectedCustomAssistant="{Binding Settings.Model.SelectedCustomAssistant, Mode=TwoWay}"
            Text="{Binding ChatInputAreaText, Mode=TwoWay}"
            TextWrapping="Wrap"
            Watermark="{Binding ChatInputAreaWatermarkKey^, FallbackValue={x:Null}}">
            <v:ChatInputArea.Transitions>
              <Transitions>
                <shadui:StringTransition
                  Easing="CubicEaseInOut" Property="Watermark"
                  Duration="0:0:0.4"/>
              </Transitions>
            </v:ChatInputArea.Transitions>

            <v:ChatInputArea.AddChatAttachmentMenuItems>
              <MenuItem
                Command="{Binding PickElementCommand}"
                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatInputArea_AddAttachmentMenuItems_PickVisualElement}}">
                <MenuItem.Icon>
                  <LucideIcon
                    Kind="SquareMousePointer"
                    Size="{DynamicResource FontSizeL}"/>
                </MenuItem.Icon>
              </MenuItem>
              <MenuItem
                Command="{Binding ScreenshotCommand}"
                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatInputArea_AddAttachmentMenuItems_Screenshot}}">
                <MenuItem.Icon>
                  <LucideIcon
                    Kind="Fullscreen"
                    Size="{DynamicResource FontSizeL}"/>
                </MenuItem.Icon>
              </MenuItem>
              <MenuItem
                Command="{Binding AddClipboardCommand}"
                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatInputArea_AddAttachmentMenuItems_PasteFromClipboard}}">
                <MenuItem.Icon>
                  <LucideIcon
                    Kind="ClipboardPaste"
                    Size="{DynamicResource FontSizeL}"/>
                </MenuItem.Icon>
              </MenuItem>
              <MenuItem
                Command="{Binding AddFileCommand}"
                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatInputArea_AddAttachmentMenuItems_AttachFile}}">
                <MenuItem.Icon>
                  <LucideIcon
                    Kind="File"
                    Size="{DynamicResource FontSizeL}"/>
                </MenuItem.Icon>
              </MenuItem>
            </v:ChatInputArea.AddChatAttachmentMenuItems>

            <v:ChatInputArea.ToolCallButtonFlyout>
              <Flyout
                Placement="Top" VerticalOffset="-4">
                <LayoutTransformControl
                  MaxHeight="600" Margin="6,2"
                  RenderTransformOrigin="50%,0%">
                  <LayoutTransformControl.Transitions>
                    <Transitions>
                      <TransformOperationsTransition
                        Property="RenderTransform" Duration="0:0:0.10"/>
                    </Transitions>
                  </LayoutTransformControl.Transitions>

                  <DockPanel VerticalSpacing="4">
                    <DockPanel.Styles>
                      <Style Selector="TreeView">
                        <Setter Property="ClipToBounds" Value="True"/>
                        <Setter Property="Template">
                          <ControlTemplate>
                            <Border
                              BorderBrush="{DynamicResource BorderColor}"
                              BorderThickness="0,0,0,1">
                              <ScrollViewer
                                Margin="0,0,-8,0" Background="Transparent"
                                BringIntoViewOnFocusChange="False" HorizontalScrollBarVisibility="Disabled"
                                VerticalScrollBarVisibility="Auto">
                                <ItemsPresenter
                                  Name="PART_ItemsPresenter" Margin="0,0,8,0"
                                  ItemsPanel="{TemplateBinding ItemsPanel}"/>
                              </ScrollViewer>
                            </Border>
                          </ControlTemplate>
                        </Setter>
                      </Style>

                      <Style Selector="TreeViewItem">
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="VerticalAlignment" Value="Center"/>
                        <Setter Property="Template">
                          <ControlTemplate>
                            <StackPanel>
                              <Border
                                x:Name="PART_LayoutRoot" Focusable="True"
                                TemplatedControl.IsTemplateFocusTarget="True">
                                <Grid x:Name="PART_Header">
                                  <Grid.ColumnDefinitions>
                                    <ColumnDefinition
                                      Width="Auto" SharedSizeGroup="Chevron"/>
                                    <ColumnDefinition/>
                                  </Grid.ColumnDefinitions>

                                  <Panel Name="PART_ExpandCollapseChevronContainer">
                                    <ToggleButton
                                      x:Name="PART_ExpandCollapseChevron" Focusable="False"
                                      IsChecked="{TemplateBinding IsExpanded, Mode=TwoWay}">
                                      <ToggleButton.Template>
                                        <ControlTemplate TargetType="ToggleButton">
                                          <Border
                                            Width="{TemplateBinding Width}"
                                            Height="{TemplateBinding Height}"
                                            HorizontalAlignment="Center" VerticalAlignment="Center"
                                            Background="Transparent">
                                            <LucideIcon
                                              x:Name="ChevronPath" HorizontalAlignment="Center"
                                              VerticalAlignment="Center" Kind="ChevronRight"
                                              Size="{DynamicResource FontSizeM}"/>
                                          </Border>
                                        </ControlTemplate>
                                      </ToggleButton.Template>

                                      <ToggleButton.Transitions>
                                        <Transitions>
                                          <TransformOperationsTransition
                                            Easing="CubicEaseInOut" Property="RenderTransform"
                                            Duration="0:0:0.10"/>
                                        </Transitions>
                                      </ToggleButton.Transitions>
                                    </ToggleButton>
                                  </Panel>
                                  <ContentPresenter
                                    x:Name="PART_HeaderPresenter" Grid.Column="1"
                                    Margin="{TemplateBinding Padding}"
                                    HorizontalAlignment="{TemplateBinding HorizontalAlignment}"
                                    VerticalAlignment="{TemplateBinding VerticalAlignment}"
                                    Background="Transparent"
                                    Content="{TemplateBinding Header}"
                                    ContentTemplate="{TemplateBinding HeaderTemplate}"
                                    Focusable="False"/>
                                </Grid>
                              </Border>
                              <ItemsPresenter
                                x:Name="PART_ItemsPresenter"
                                IsVisible="{TemplateBinding IsExpanded}"
                                ItemsPanel="{TemplateBinding ItemsPanel}"/>
                            </StackPanel>
                          </ControlTemplate>
                        </Setter>
                      </Style>

                      <Style Selector="ToggleButton#PART_ExpandCollapseChevron:checked">
                        <Setter Property="RenderTransform">
                          <Setter.Value>
                            <RotateTransform Angle="90"/>
                          </Setter.Value>
                        </Setter>
                      </Style>
                    </DockPanel.Styles>

                    <DockPanel
                      DockPanel.Dock="Bottom" Margin="0,0,2,0">
                      <ToggleSwitch
                        DockPanel.Dock="Right" VerticalAlignment="Center"
                        IsChecked="{Binding $parent[v:ChatWindow].ViewModel.PersistentState.IsToolCallEnabled, Mode=TwoWay}"/>

                      <TextBlock
                        VerticalAlignment="Center"
                        Text="{I18N {x:Static LocaleKey.ChatInputArea_ToolCallButton_Header}}"/>
                    </DockPanel>

                    <TreeView
                      Grid.IsSharedSizeScope="True"
                      IsVisible="{Binding $parent[v:ChatWindow].ViewModel.PersistentState.IsToolCallEnabled}"
                      ItemsSource="{Binding $parent[v:ChatWindow].ViewModel.ChatPlugins}">
                      <TreeView.DataTemplates>
                        <TreeDataTemplate
                          DataType="p:ChatPlugin"
                          ItemsSource="{Binding Functions}">
                          <Border>
                            <Grid ColumnSpacing="4">
                              <Grid.ColumnDefinitions>
                                <ColumnDefinition
                                  Width="Auto" SharedSizeGroup="Icon"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                              </Grid.ColumnDefinitions>

                              <LucideIcon
                                Grid.Column="0" VerticalAlignment="Center"
                                Kind="{Binding Icon}"
                                Size="{DynamicResource FontSizeL}"/>

                              <TextBlock
                                Grid.Column="1" VerticalAlignment="Center"
                                Text="{Binding HeaderKey^}"
                                ToolTip.Placement="Top"
                                ToolTip.Tip="{Binding DescriptionKey^}"/>

                              <ToggleSwitch
                                Grid.Column="2" VerticalAlignment="Center"
                                IsChecked="{Binding IsEnabled, Mode=TwoWay}"/>
                            </Grid>
                          </Border>
                        </TreeDataTemplate>

                        <DataTemplate DataType="p:ChatFunction">
                          <DockPanel
                            Margin="16,0,0,0" HorizontalSpacing="4">
                            <ToggleSwitch
                              DockPanel.Dock="Right" VerticalAlignment="Center"
                              IsChecked="{Binding IsEnabled, Mode=TwoWay}"/>

                            <TextBlock
                              VerticalAlignment="Center"
                              Text="{Binding HeaderKey^}"
                              ToolTip.Placement="Top"
                              ToolTip.Tip="{Binding DescriptionKey^}"/>
                          </DockPanel>
                        </DataTemplate>
                      </TreeView.DataTemplates>
                    </TreeView>
                  </DockPanel>
                </LayoutTransformControl>
              </Flyout>
            </v:ChatInputArea.ToolCallButtonFlyout>

            <v:ChatInputArea.SettingsMenuItemsSource>
              <StackPanel
                Orientation="Vertical" Spacing="4">
                <StackPanel
                  Orientation="Horizontal" Spacing="4">
                  <TextBlock
                    VerticalAlignment="Center"
                    FontSize="{DynamicResource FontSizeS}"
                    Text="{I18N {x:Static LocaleKey.ChatWindow_ChatInputArea_SettingsMenuItems_VisualTreeTokenLimit}}"/>
                  <LucideIcon
                    Kind="CircleQuestionMark"
                    Size="{DynamicResource FontSizeS}"
                    ToolTip.Placement="Right"
                    ToolTip.Tip="{I18N {x:Static LocaleKey.ChatWindow_ChatInputArea_SettingsMenuItems_VisualTreeTokenLimit_Tip}}"/>
                </StackPanel>

                <TextBlock
                  Classes="Muted" VerticalAlignment="Center"
                  FontSize="{DynamicResource FontSizeS}"
                  Text="{Binding PersistentState.VisualTreeTokenLimit, Mode=OneWay}"/>

                <Slider
                  MinWidth="200" VerticalAlignment="Center">
                  <Interaction.Behaviors>
                    <be:LogarithmicSliderBehavior
                      Maximum="{Binding Settings.Model.SelectedCustomAssistant.MaxTokens, FallbackValue=8192, Converter={x:Static vc:DoubleConverters.Multiply}, ConverterParameter=0.5}"
                      Minimum="512"
                      Value="{Binding PersistentState.VisualTreeTokenLimit, Mode=TwoWay}"/>
                  </Interaction.Behaviors>
                </Slider>

                <Separator/>
              </StackPanel>

              <StackPanel
                Margin="0,4,0,0" Orientation="Vertical"
                Spacing="4">
                <StackPanel
                  Orientation="Horizontal" Spacing="4">
                  <TextBlock
                    VerticalAlignment="Center"
                    FontSize="{DynamicResource FontSizeS}"
                    Text="{I18N {x:Static LocaleKey.PersistentState_VisualTreeDetailLevel_Header}}"/>
                  <LucideIcon
                    Kind="CircleQuestionMark"
                    Size="{DynamicResource FontSizeS}"
                    ToolTip.Placement="Right"
                    ToolTip.Tip="{I18N {x:Static LocaleKey.PersistentState_VisualTreeDetailLevel_Description}}"/>
                </StackPanel>

                <TextBlock
                  Classes="Muted" VerticalAlignment="Center"
                  FontSize="{DynamicResource FontSizeS}">
                  <TextBlock.Text>
                    <I18N Key="{Binding PersistentState.VisualTreeDetailLevel, Converter={x:Static vc:DynamicResourceKeyConverter.Shared}}"/>
                  </TextBlock.Text>
                </TextBlock>

                <Slider
                  MinWidth="160" IsSnapToTickEnabled="True"
                  Maximum="2" Minimum="0"
                  TickFrequency="1"
                  Value="{Binding PersistentState.VisualTreeDetailLevel, Mode=TwoWay, Converter={x:Static vc:Int32Converters.FromEnum}}"/>

                <Separator/>
              </StackPanel>

              <StackPanel
                Margin="0,4,0,0"
                IsVisible="{Binding Settings.Model.SelectedCustomAssistant.IsDeepThinkingSupported, FallbackValue=False}"
                Orientation="Vertical" Spacing="4">
                <TextBlock
                  VerticalAlignment="Center"
                  FontSize="{DynamicResource FontSizeS}"
                  Text="{I18N {x:Static LocaleKey.PersistentState_ReasoningEffortLevel_Header}}"/>

                <TextBlock
                  Classes="Muted" VerticalAlignment="Center"
                  FontSize="{DynamicResource FontSizeS}">
                  <TextBlock.Text>
                    <I18N Key="{Binding PersistentState.ReasoningEffortLevel, Converter={x:Static vc:DynamicResourceKeyConverter.Shared}}"/>
                  </TextBlock.Text>
                </TextBlock>

                <Slider
                  MinWidth="160" IsSnapToTickEnabled="True"
                  Maximum="2" Minimum="0"
                  TickFrequency="1"
                  Value="{Binding PersistentState.ReasoningEffortLevel, Mode=TwoWay, Converter={x:Static vc:Int32Converters.FromEnum}}"/>

                <Separator/>
              </StackPanel>

              <Button
                Classes="Secondary Compact" Margin="0,4,0,0"
                shadui:ButtonAssist.Icon="{LucideIconContent Settings2}"
                Command="{Binding OpenSettingsCommand}"
                Content="{I18N {x:Static LocaleKey.ChatWindow_ChatInputArea_SettingsMenuItems_MoreSettings}}"/>
            </v:ChatInputArea.SettingsMenuItemsSource>
          </v:ChatInputArea>
        </StackPanel>
      </Border>
    </Grid>

    <Grid
      IsSharedSizeScope="True"
      IsVisible="{Binding IsViewingHistory}"
      RowDefinitions="Auto,Auto,*">
      <Border
        Grid.Row="0" Padding="4,2"
        BorderBrush="{DynamicResource BorderColor}"
        BorderThickness="0,0,0,0">
        <Panel Margin="0,2,4,2">
          <Button
            Classes="Ghost" Height="30"
            Padding="6,4" HorizontalAlignment="Left"
            shadui:ButtonAssist.Icon="{LucideIconContent ArrowLeft}"
            Command="{Binding SwitchViewingHistoryCommand}"
            CommandParameter="False"
            Content="{I18N {x:Static LocaleKey.ChatWindow_BackAllHistoryButton_Content}}"/>

          <Menu HorizontalAlignment="Right">
            <MenuItem
              Classes="Ghost" Height="30"
              Padding="6,4" shadui:MenuItemAssist.PopupPlacement="Bottom">
              <MenuItem.Header>
                <LucideIcon
                  HorizontalAlignment="Center" VerticalAlignment="Center"
                  Kind="Ellipsis"
                  Size="{DynamicResource FontSizeL}"/>
              </MenuItem.Header>

              <MenuItem
                Command="{Binding $parent[v:ChatWindow].ViewModel.ChatContextManager.RemoveSelectedCommand}"
                CommandParameter="{Binding}"
                Foreground="{DynamicResource DestructiveColor}"
                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatHistory_DeleteSelectedMenuItem_Header}}">
                <MenuItem.Icon>
                  <LucideIcon
                    Foreground="{DynamicResource DestructiveColor}"
                    Kind="Trash2" Size="16"/>
                </MenuItem.Icon>
              </MenuItem>
            </MenuItem>
          </Menu>
        </Panel>
      </Border>

      <Grid
        Margin="23,8,20,2" Row="1">
        <Grid.ColumnDefinitions>
          <ColumnDefinition
            Width="Auto" SharedSizeGroup="Check"/>
          <ColumnDefinition/>
          <ColumnDefinition
            Width="Auto" SharedSizeGroup="Date"/>
          <ColumnDefinition
            Width="Auto" SharedSizeGroup="Action"/>
        </Grid.ColumnDefinitions>

        <CheckBox
          Grid.Column="0"
          IsChecked="{Binding IsAllHistorySelected}"/>
        <TextBlock
          Grid.Column="1" Margin="8,0"
          VerticalAlignment="Center"
          Text="{I18N {x:Static LocaleKey.ChatContext_Metadata_Topic_Header}}"/>
        <TextBlock
          Grid.Column="2" VerticalAlignment="Center"
          Text="{I18N {x:Static LocaleKey.ChatContext_Metadata_DateModified_Header}}"/>
      </Grid>

      <ScrollViewer
        Grid.Row="2" HorizontalContentAlignment="Stretch"
        HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
        <Interaction.Behaviors>
          <be:AutoLoadBehavior Command="{Binding $parent[v:ChatWindow].ViewModel.ChatContextManager.LoadMoreHistoryCommand}">
            <be:AutoLoadBehavior.CommandParameter>
              <sys:Int32>20</sys:Int32>
            </be:AutoLoadBehavior.CommandParameter>
          </be:AutoLoadBehavior>
        </Interaction.Behaviors>

        <ItemsControl
          Margin="8" Padding="0"
          ItemsSource="{Binding ChatContextManager.AllHistory}">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <StackPanel
                Orientation="Vertical" Spacing="8"/>
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>

          <ItemsControl.ItemTemplate>
            <DataTemplate DataType="chat:ChatContextHistory">
              <StackPanel
                Orientation="Vertical" Spacing="4">
                <TextBlock
                  Classes="Muted" HorizontalAlignment="Left"
                  FontSize="{DynamicResource FontSizeS}">
                  <TextBlock.Text>
                    <I18N Key="{Binding Date, Converter={x:Static vc:DynamicResourceKeyConverter.Shared}}"/>
                  </TextBlock.Text>
                </TextBlock>

                <ListBox
                  x:Name="ChatContextMetadataListBox" Padding="0"
                  Background="Transparent" BorderThickness="0"
                  CornerRadius="0"
                  ItemsSource="{Binding MetadataList}"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                  SelectedItem="{Binding $parent[v:ChatWindow].ViewModel.ChatContextManager.CurrentMetadata, FallbackValue={x:Null}}">
                  <ListBox.Styles>
                    <Style Selector="ListBoxItem">
                      <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                      <Setter Property="Padding" Value="10,2"/>
                    </Style>
                    <Style Selector="LucideIcon">
                      <Setter Property="Size" Value="{DynamicResource FontSizeM}"/>
                    </Style>
                  </ListBox.Styles>

                  <ListBox.ItemTemplate>
                    <DataTemplate DataType="chat:ChatContextMetadata">
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition
                            Width="Auto" SharedSizeGroup="Check"/>
                          <ColumnDefinition/>
                          <ColumnDefinition
                            Width="Auto" SharedSizeGroup="Date"/>
                          <ColumnDefinition
                            Width="Auto" SharedSizeGroup="Action"/>
                        </Grid.ColumnDefinitions>

                        <CheckBox
                          Grid.Column="0"
                          IsChecked="{Binding IsSelected, Mode=TwoWay}"/>
                        <TextBlock
                          Grid.Column="1" Margin="8,0"
                          VerticalAlignment="Center"
                          IsVisible="{Binding IsTemporary}"
                          Opacity="0.6"
                          Text="{I18N {x:Static LocaleKey.ChatContext_Temporary}}"/>
                        <shadui:EditableTextBlock
                          x:Name="TopicEditableTextBlock" Grid.Column="1"
                          Margin="8,0" VerticalAlignment="Center"
                          FontSize="{DynamicResource FontSizeM}"
                          IsEditing="{Binding IsRenaming, Mode=TwoWay}"
                          IsVisible="{Binding !IsTemporary}"
                          Text="{Binding Topic, Mode=TwoWay}"
                          TextTrimming="CharacterEllipsis"
                          Watermark="{I18N {x:Static LocaleKey.ChatContext_Metadata_Topic_Default}}"/>
                        <TextBlock
                          Grid.Column="2" VerticalAlignment="Center"
                          Text="{Binding LocalDateModified, StringFormat='{}{0:G}'}"
                          TextTrimming="CharacterEllipsis"/>
                        <Button
                          Grid.Column="3" Margin="8,0,0,0"
                          Content="{LucideIconContent Ellipsis}">
                          <Button.Flyout>
                            <MenuFlyout>
                              <MenuItem
                                Command="{Binding #TopicEditableTextBlock.EnterEditMode}"
                                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatHistory_RenameMenuItem_Header}}"
                                Icon="{LucideIconContent Pencil}"
                                IsVisible="{Binding !IsTemporary}"/>
                              <MenuItem
                                Command="{Binding $parent[v:ChatWindow].ViewModel.ExportMarkdownCommand}"
                                CommandParameter="{Binding}"
                                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatHistory_ExportMarkdownMenuItem_Header}}"
                                Icon="{LucideIconContent Upload}"/>
                              <MenuItem
                                Command="{Binding $parent[v:ChatWindow].ViewModel.ChatContextManager.RemoveCommand}"
                                CommandParameter="{Binding}"
                                Foreground="{DynamicResource DestructiveColor}"
                                Header="{I18N {x:Static LocaleKey.ChatWindow_ChatHistory_DeleteMenuItem_Header}}">
                                <MenuItem.Icon>
                                  <LucideIcon
                                    Foreground="{DynamicResource DestructiveColor}"
                                    Kind="Trash2"/>
                                </MenuItem.Icon>
                              </MenuItem>
                            </MenuFlyout>
                          </Button.Flyout>
                        </Button>
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </StackPanel>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>
    </Grid>
    <Border
      x:Name="DragDropOverlay" Background="#CC000000"
      IsVisible="False">
      <StackPanel
        HorizontalAlignment="Center" VerticalAlignment="Center"
        Spacing="16">
        <LucideIcon
          x:Name="DragDropIcon" HorizontalAlignment="Center"
          Foreground="{DynamicResource ForegroundColor}"
          Kind="FileUp" Size="64"/>
        <TextBlock
          x:Name="DragDropText" HorizontalAlignment="Center"
          FontSize="18" FontWeight="SemiBold"
          Foreground="{DynamicResource ForegroundColor}"
          Text="{I18N {x:Static LocaleKey.ChatWindow_DragDrop_Overlay_DropFilesHere}}"/>
      </StackPanel>
    </Border>
  </Panel>
</v:ReactiveShadWindow>